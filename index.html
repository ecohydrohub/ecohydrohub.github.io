<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A curated collection of hydrology, meteorological, and ecological data sources.">
    <title>EcoHydroData Hub</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* === 1. GLOBAL VARIABLES & THEME (CUSTOMIZE HERE) === */
        :root {
            /* Brand Colors */
            --primary: #4f46e5;
            /* Indigo */
            --primary-hover: #4338ca;
            --primary-light: #e0e7ff;
            --accent: #06b6d4;
            /* Cyan */

            /* Backgrounds */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;

            /* Text */
            --text-main: #1e293b;
            --text-muted: #64748b;

            /* === CUSTOMIZABLE VARIABLE TAGS === */
            --tag-bg: #f1f5f9;
            /* Light Gray Background */
            --tag-text: #334155;
            /* Dark Slate Text */
            --tag-radius: 6px;
            /* Rounded corners */
            --tag-font-size: 0.75rem;

            /* Shadows */
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);

            /* Border Radius */
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-pill: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* === LAYOUT === */
        #app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* === HEADER === */
        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            padding: 4rem 2rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-card);
            margin-bottom: 3rem;
            border: 1px solid white;
        }

        .main-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.75rem;
            letter-spacing: -0.03em;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
            font-weight: 500;
        }

        /* === SEARCH & FILTERS === */
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1.25rem;
            pointer-events: none;
        }

        input,
        select {
            width: 100%;
            padding: 1rem 1.5rem 1rem 3rem;
            border: 1px solid #f1f5f9;
            border-radius: var(--radius-pill);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        select {
            padding-left: 1.5rem;
            cursor: pointer;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .results-info {
            width: 100%;
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* === CATEGORIES === */
        .category-section {
            margin-bottom: 4rem;
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
        }

        .category-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.75rem;
            color: var(--text-main);
            font-weight: 700;
            display: flex;
            align-items: center;
        }

        .category-title::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent);
            margin-right: 16px;
            border-radius: 50%;
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .category-count {
            margin-left: 1rem;
            background: var(--primary-light);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: var(--radius-pill);
            font-size: 0.85rem;
            font-weight: 700;
        }

        .category-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 2rem;
            align-items: stretch;
        }

        /* === DATA CARD === */
        .data-card {
            background: var(--bg-card);
            box-shadow: var(--shadow-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .data-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .card-header h3 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.35rem;
            line-height: 1.3;
            margin-bottom: 0.75rem;
            color: var(--text-main);
            font-weight: 700;
        }

        .badge-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary);
            background: var(--primary-light);
            padding: 6px 12px;
            border-radius: 8px;
            margin-bottom: 1.25rem;
        }

        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* === 1. FIXED SCROLL FADE === */
        /* Wrapper creates the positioning context for the fade */
        .description-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
            /* Border radius to match scrollbar if visible */
            border-radius: 4px;
        }

        .description-box {
            color: var(--text-muted);
            font-size: 0.95rem;
            height: 130px;
            overflow-y: auto;
            padding-right: 12px;
            white-space: pre-line;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
            padding-bottom: 20px;
            /* Space for the fade so text isn't totally hidden */
        }

        /* The Gradient Overlay */
        .description-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 12px;
            /* Stop before scrollbar */
            height: 40px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
            pointer-events: none;
            /* Allows clicking/scrolling through the fade */
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .description-box::-webkit-scrollbar {
            width: 6px;
        }

        .description-box::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .description-box a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            border-bottom: 1px solid transparent;
            transition: border 0.2s;
        }

        .description-box a:hover {
            border-bottom-color: var(--primary);
        }

        /* === 2. CUSTOMIZABLE VARIABLES TAGS === */
        .variables-area {
            margin-bottom: 1.5rem;
            min-height: 80px;
        }

        .variables-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #94a3b8;
            margin-bottom: 0.75rem;
        }

        .variables-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 64px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .variables-wrapper.expanded {
            max-height: 500px;
        }

        /* The Customizable Tag */
        .var-tag {
            font-size: var(--tag-font-size);
            padding: 4px 10px;
            background: var(--tag-bg);
            color: var(--tag-text);
            border-radius: var(--tag-radius);
            font-weight: 600;
            transition: all 0.2s;
        }

        .var-tag:hover {
            filter: brightness(0.95);
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 0;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* === METADATA === */
        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem 1rem;
            font-size: 0.9rem;
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid #f1f5f9;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .meta-label i {
            font-size: 1rem;
            color: var(--primary);
        }

        .meta-value {
            color: var(--text-main);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* === BUTTONS === */
        .card-footer {
            margin-top: 2rem;
        }

        .btn-visit {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25);
            transition: all 0.2s;
        }

        .btn-visit:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        }

        /* === UTILITY === */
        .hidden {
            display: none !important;
        }

        .loader {
            padding: 4rem;
            text-align: center;
            color: var(--text-muted);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* === MODAL === */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 550px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-hover);
        }

        .modal-header {
            background: var(--primary);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 2rem;
            font-size: 1rem;
            color: var(--text-main);
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
        }

        /* === FOOTER === */
        .footer {
            margin-top: auto;
            text-align: center;
            padding: 4rem 0 2rem;
            color: var(--text-muted);
        }

        .footer-logos img {
            height: 50px;
            margin: 0 20px;
            filter: grayscale(100%);
            opacity: 0.5;
            transition: 0.3s;
        }

        .footer-logos img:hover {
            filter: grayscale(0%);
            opacity: 1;
        }

        .footer-links a {
            color: var(--primary);
            text-decoration: none;
            margin: 0 12px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header {
                padding: 3rem 1.5rem;
            }

            .main-title {
                font-size: 2.25rem;
            }

            .input-wrapper {
                min-width: 100%;
            }
        }
    </style>
</head>

<body>

    <div id="app-container">
        <header class="header">
            <h1 class="main-title">EcoHydroData Hub</h1>
            <p class="subtitle">Curated datasets for hydrological and ecological research</p>

            <div class="controls-container">
                <div class="input-wrapper">
                    <i class="ph ph-magnifying-glass search-icon"></i>
                    <input type="text" id="search-input" placeholder="Search datasets, keywords, variables...">
                </div>
                <div class="input-wrapper" style="flex: 0 0 240px;">
                    <select id="category-filter">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="results-info" id="results-count">Loading data sources...</div>
            </div>
        </header>

        <main id="main-content">
            <div id="loader" class="loader">
                <div class="spinner"></div>
                <p>Fetching latest data...</p>
            </div>

            <div id="error-container" class="hidden" style="text-align: center; padding: 3rem; color: #ef4444;">
                <i class="ph ph-warning-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h3>Unable to load data</h3>
                <p id="error-message" style="margin-bottom: 1.5rem;">Please try refreshing the page.</p>
                <button onclick="handleRetry()" class="btn-visit"
                    style="max-width: 200px; margin: 0 auto;">Retry</button>
            </div>

            <div id="data-container"></div>

            <div id="no-results" class="hidden" style="text-align: center; padding: 4rem;">
                <i class="ph ph-magnifying-glass" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                <h3>No matching datasets found</h3>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Try adjusting your search terms or filters.
                </p>
                <button onclick="clearAllFilters()" class="btn-visit" style="max-width: 200px; margin: 0 auto;">Clear
                    Filters</button>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-logos">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/Uc_merced_logo.png" alt="UC Merced">
                <img src="https://snri.ucmerced.edu/sites/snri.ucmerced.edu/files/page/images/160328_snri_logo.png"
                    alt="SNRI">
            </div>
            <p class="footer-links" style="margin-bottom: 1rem; margin-top: 2rem;">
                <a href="#" id="about-link">About</a>
                <a href="#" id="contact-link">Contact</a>
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSejfEB6pJpLNQRgt0Wlmj7pgd_wnMI8UZ-pvvK10W-SCDs8vQ/viewform"
                    target="_blank">Suggest Data</a>
            </p>
            <p style="font-size: 0.85rem;">&copy; 2025 Hydrology Research Lab</p>
        </footer>
    </div>

    <div id="info-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>About This Project</h3>
                <button class="close-btn" onclick="hideModal('info-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>This website catalogs essential data sources for Eco-hydrology research. Data is maintained in Google
                    Sheets and updated regularly.</p>
            </div>
        </div>
    </div>

    <div id="contact-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Contact Team</h3>
                <button class="close-btn" onclick="hideModal('contact-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 0.5rem"><strong>Dr. Saswata Nandi:</strong> <a
                        href="mailto:snandi4@ucmerced.edu" style="color:var(--primary)">snandi4@ucmerced.edu</a></p>
                <p style="margin-bottom: 0.5rem"><strong>Dr. Abhishek Chakraborty:</strong> <a
                        href="mailto:achakraborty8@ucmerced.edu"
                        style="color:var(--primary)">achakraborty8@ucmerced.edu</a></p>
                <p style="margin-bottom: 0.5rem"><strong>Dr. Rui Gao:</strong> <a href="mailto:ruigao@ucmerced.edu"
                        style="color:var(--primary)">ruigao@ucmerced.edu</a></p>
                <p style="margin-bottom: 0.5rem"><strong>Berhanu Sinshaw:</strong> <a
                        href="mailto:bsinshaw@ucmerced.edu" style="color:var(--primary)">bsinshaw@ucmerced.edu</a></p>
                <p><strong>Sahir Azam Shad:</strong> <a href="mailto:sahirazamshad@ucmerced.edu"
                        style="color:var(--primary)">sahirazamshad@ucmerced.edu</a></p>
            </div>
        </div>
    </div>

    <script>
        // === 3. DEBUGGING & CONFIG (RESTORED) ===
        const API_CONFIG = {
            url: 'https://script.google.com/macros/s/AKfycbwn52BYcRtIV2FY7mqJ4nJrX1wd_nx4FJtbRM5bqF3to2ApEiLE0gfEuCA8leb3jMnU/exec',
            timeout: 10000,
            retryAttempts: 2
        };

        // GLOBAL STATE
        let allDataSources = [];
        let filteredDataSources = [];
        let currentCategory = 'all';
        let currentSearchTerm = '';
        let isLoading = false;
        let retryCount = 0;

        const els = {
            loader: document.getElementById('loader'),
            container: document.getElementById('data-container'),
            error: document.getElementById('error-container'),
            noResults: document.getElementById('no-results'),
            search: document.getElementById('search-input'),
            filter: document.getElementById('category-filter'),
            count: document.getElementById('results-count'),
            errorMsg: document.getElementById('error-message')
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (!checkBrowserSupport()) return;
            initializePerformanceMonitoring();
            handleGlobalErrors();
            fetchDataSources();
            setupListeners();
        });

        // === LOGIC ===
        async function fetchDataSources() {
            if (isLoading) return;
            isLoading = true;
            els.loader.classList.remove('hidden');
            els.error.classList.add('hidden');

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

            try {
                const response = await fetch(API_CONFIG.url, { method: 'GET', signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const json = await response.json();
                if (json.success === false) throw new Error(json.error || 'API Error');

                allDataSources = Array.isArray(json) ? json : json.data || [];
                if (allDataSources.length === 0) throw new Error('No data found');

                allDataSources.sort((a, b) => (a.Name || '').localeCompare(b.Name || ''));
                populateFilter();
                applyFilters();
                retryCount = 0;

            } catch (err) {
                console.error('Fetch error:', err);
                if (retryCount < API_CONFIG.retryAttempts) {
                    retryCount++;
                    setTimeout(() => { isLoading = false; fetchDataSources(); }, 2000);
                } else {
                    showErrorState(err.message);
                }
            } finally {
                isLoading = false;
                els.loader.classList.add('hidden');
            }
        }

        function showErrorState(msg) {
            els.error.classList.remove('hidden');
            els.container.innerHTML = '';
            els.errorMsg.textContent = msg === 'AbortError' ? "Request timed out." : "Unable to load data.";
        }

        function applyFilters() {
            if (!allDataSources.length) return;
            currentSearchTerm = els.search.value.toLowerCase().trim();
            currentCategory = els.filter.value;

            filteredDataSources = allDataSources.filter(item => {
                const searchableText = [
                    item.Name || '', item.Description || '', item.Variables || '', item.Keywords || '', item.Category || '',
                    item.SpatialCoverage || '', item.TemporalCoverage || '', item.SpatialResolution || '', item.TemporalResolution || ''
                ].join(' ').toLowerCase();

                const matchesSearch = !currentSearchTerm || searchableText.includes(currentSearchTerm);
                const matchesCat = currentCategory === 'all' || item.Category === currentCategory;
                return matchesSearch && matchesCat;
            });

            els.count.textContent = `${filteredDataSources.length} datasets found`;
            render();
        }

        function render() {
            els.container.innerHTML = '';
            if (filteredDataSources.length === 0) {
                els.noResults.classList.remove('hidden');
                return;
            } else {
                els.noResults.classList.add('hidden');
            }

            const grouped = {};
            filteredDataSources.forEach(item => {
                const cat = item.Category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            Object.keys(grouped).sort().forEach(category => {
                const section = document.createElement('section');
                section.className = 'category-section';
                const cardsHTML = grouped[category].map(createCardHTML).join('');
                section.innerHTML = `
                    <div class="category-header">
                        <h2 class="category-title">${escapeHTML(category)}</h2>
                        <span class="category-count">${grouped[category].length}</span>
                    </div>
                    <div class="category-cards">${cardsHTML}</div>
                `;
                els.container.appendChild(section);
            });
            setTimeout(checkVariableOverflows, 100);
        }

        function createCardHTML(item) {
            const safe = (str) => escapeHTML(str || 'N/A');
            const description = (item.Description || '').trim();
            const variables = (item.Variables || '').split(',').map(v => v.trim()).filter(v => v);
            const varsHTML = variables.length > 0
                ? variables.map(v => `<span class="var-tag">${escapeHTML(v)}</span>`).join('')
                : '<span style="font-style:italic; font-size: 0.8rem; color:#94a3b8;">No variables specified</span>';
            const uniqueId = Math.random().toString(36).substr(2, 9);

            return `
            <div class="data-card">
                <div class="card-header">
                    <h3>${safe(item.Name)}</h3>
                    <div class="badge-category"><i class="ph-bold ph-tag"></i> ${safe(item.Category)}</div>
                </div>
                
                <div class="card-body">
                    <div class="description-wrapper">
                        <div class="description-box">
                            ${formatDescription(description)}
                        </div>
                    </div>

                    <div class="variables-area">
                        <span class="variables-label"><i class="ph-bold ph-list-dashes"></i> Variables</span>
                        <div class="variables-wrapper" id="vars-${uniqueId}">
                            ${varsHTML}
                        </div>
                        <button class="toggle-btn hidden" id="btn-${uniqueId}" onclick="toggleVars('${uniqueId}')">
                            Show all <i class="ph-bold ph-caret-down"></i>
                        </button>
                    </div>

                    <div class="metadata-grid">
                        <div class="meta-item">
                            <span class="meta-label"><i class="ph-bold ph-ruler"></i> Spatial Res.</span>
                            <span class="meta-value">${safe(item.SpatialResolution)}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label"><i class="ph-bold ph-timer"></i> Temporal Res.</span>
                            <span class="meta-value">${safe(item.TemporalResolution)}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label"><i class="ph-bold ph-globe-hemisphere-west"></i> Spatial Cov.</span>
                            <span class="meta-value">${safe(item.SpatialCoverage)}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label"><i class="ph-bold ph-calendar-blank"></i> Temporal Cov.</span>
                            <span class="meta-value">${safe(item.TemporalCoverage)}</span>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <a href="${item.Link || '#'}" target="_blank" class="btn-visit">
                        Visit Data Source <i class="ph-bold ph-arrow-right"></i>
                    </a>
                </div>
            </div>
            `;
        }

        function formatDescription(text) {
            if (!text) return '';
            let formatted = text.trim();
            formatted = formatted.replace(/((https?:\/\/)|(http?:\/\/)|(www\.))[^\s]+/g, (url) => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
            formatted = formatted.replace(/(Paper:)/gi, '<br><br><strong>$1</strong>');
            formatted = formatted.replace(/(Alternate link\s*\d*:)/gi, '<br><br><strong>$1</strong>');
            return formatted;
        }

        function checkBrowserSupport() { if (!('fetch' in window)) { els.container.innerHTML = 'Browser update required.'; return false; } return true; }
        function handleGlobalErrors() { window.addEventListener('error', (e) => console.error('Global:', e.error)); }
        function initializePerformanceMonitoring() { if (window.performance) window.addEventListener('load', () => console.log('Loaded')); }
        function populateFilter() {
            const categories = [...new Set(allDataSources.map(d => d.Category))].filter(Boolean).sort();
            els.filter.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; els.filter.appendChild(o); });
        }
        function setupListeners() {
            els.search.addEventListener('input', debounce(applyFilters, 300));
            els.filter.addEventListener('change', applyFilters);
            document.getElementById('about-link').onclick = (e) => { e.preventDefault(); showModal('info-modal'); };
            document.getElementById('contact-link').onclick = (e) => { e.preventDefault(); showModal('contact-modal'); };
            window.onclick = (e) => { if (e.target.classList.contains('modal')) e.target.classList.add('hidden'); }
        }
        function handleRetry() { retryCount = 0; fetchDataSources(); }
        function clearAllFilters() { els.search.value = ''; els.filter.value = 'all'; applyFilters(); }
        function escapeHTML(str) { const d = document.createElement('div'); d.textContent = str || ''; return d.innerHTML; }
        function debounce(func, wait) { let t; return function (...args) { clearTimeout(t); t = setTimeout(() => func.apply(this, args), wait); }; }
        function checkVariableOverflows() {
            document.querySelectorAll('.variables-wrapper').forEach(w => {
                if (w.scrollHeight > 65) { const id = w.id.split('-')[1]; const b = document.getElementById(`btn-${id}`); if (b) b.classList.remove('hidden'); }
            });
        }
        window.toggleVars = function (id) {
            const w = document.getElementById(`vars-${id}`); const b = document.getElementById(`btn-${id}`);
            if (w.classList.contains('expanded')) { w.classList.remove('expanded'); b.innerHTML = `Show all <i class="ph-bold ph-caret-down"></i>`; }
            else { w.classList.add('expanded'); b.innerHTML = `Show less <i class="ph-bold ph-caret-up"></i>`; }
        };
        window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id).classList.add('hidden');

        // === RESTORED DEBUGGING OBJECT ===
        window.EcoHydroDataHub = {
            getAllDataSources: () => allDataSources,
            reload: fetchDataSources,
            getConfig: () => API_CONFIG
        };
    </script>
</body>

</html>
